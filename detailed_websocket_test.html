<!DOCTYPE html>
<html>
<head>
    <title>Detailed WebSocket Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 5px 0; border-radius: 5px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .info { background: #e3f2fd; color: #1565c0; }
    </style>
</head>
<body>
    <h1>Detailed WebSocket Test</h1>
    <div id="logs"></div>
    
    <script>
        const token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3NTgzODIwNzEsInN1YiI6IjUzNjRlNjhhLTcyYWUtNDVmNy1iNjNiLTBhY2Q1MjRmZjE2OCJ9.JPkiLqCrqxqDTxhq4dX7gDCZtFdbEuJv23WyuI_U_kc';
        const roomId = 1;
        
        function addLog(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = new Date().toLocaleTimeString() + ': ' + message;
            document.getElementById('logs').appendChild(div);
            console.log(message);
        }
        
        function testWebSocket() {
            const wsUrl = `ws://medic.yoon.today/api/chat/ws/${roomId}?token=${token}`;
            addLog('Starting WebSocket test...', 'info');
            addLog('URL: ' + wsUrl, 'info');
            
            // 브라우저 정보
            addLog('User Agent: ' + navigator.userAgent, 'info');
            addLog('WebSocket Support: ' + (typeof WebSocket !== 'undefined'), 'info');
            
            const ws = new WebSocket(wsUrl);
            
            ws.onopen = function(event) {
                addLog('✅ WebSocket 연결 성공!', 'success');
                addLog('Ready State: ' + ws.readyState, 'success');
                addLog('Protocol: ' + ws.protocol, 'success');
            };
            
            ws.onmessage = function(event) {
                addLog('📨 메시지 수신: ' + event.data, 'success');
            };
            
            ws.onclose = function(event) {
                addLog('❌ WebSocket 연결 종료', 'error');
                addLog('Close Code: ' + event.code, 'error');
                addLog('Close Reason: ' + event.reason, 'error');
                addLog('Was Clean: ' + event.wasClean, 'error');
                
                // 오류 코드별 설명
                const codeDescriptions = {
                    1000: '정상 종료',
                    1001: '엔드포인트가 사라짐',
                    1002: '프로토콜 오류',
                    1003: '지원하지 않는 데이터 타입',
                    1006: '비정상적인 연결 종료 (서버 응답 없음)',
                    1007: '잘못된 프레임 데이터',
                    1008: '정책 위반',
                    1009: '메시지가 너무 큼',
                    1010: '확장 협상 실패',
                    1011: '서버 오류'
                };
                
                if (codeDescriptions[event.code]) {
                    addLog('오류 설명: ' + codeDescriptions[event.code], 'error');
                }
            };
            
            ws.onerror = function(error) {
                addLog('❌ WebSocket 오류 발생', 'error');
                addLog('Error: ' + JSON.stringify(error), 'error');
                addLog('Ready State: ' + ws.readyState, 'error');
            };
            
            // 연결 상태 모니터링
            setTimeout(() => {
                addLog('연결 상태 체크 (5초 후): ' + ws.readyState, 'info');
                if (ws.readyState === WebSocket.CONNECTING) {
                    addLog('⚠️ 아직 연결 중...', 'error');
                } else if (ws.readyState === WebSocket.OPEN) {
                    addLog('✅ 연결 성공!', 'success');
                } else {
                    addLog('❌ 연결 실패 또는 종료됨', 'error');
                }
            }, 5000);
        }
        
        // 페이지 로드 시 자동 테스트
        window.onload = function() {
            addLog('페이지 로드 완료', 'info');
            addLog('WebSocket 테스트 시작...', 'info');
            testWebSocket();
        };
    </script>
</body>
</html>
